name: Build OpenWrt for ZBT-Z8102AX-eMMC

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/build-openwrt.yml'
      - 'config/**'
      - 'dts/**'
      - 'patches/**'
  pull_request:
    branches: [ main, master ]
  schedule:
    # 每月1号早上6点自动编译
    - cron: '0 6 1 * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt 版本'
        required: true
        default: '24.10.4'
        type: choice
        options:
          - '24.10.4'
          - 'master'

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: ${{ github.event.inputs.version || 'openwrt-24.10.4' }}
  FEEDS_CONF: feeds.conf.default
  TARGET: mediatek
  SUBTARGET: mt7981
  PROFILE: zbtlink_z8102ax-emmc
  BUILD_THREADS: 4

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: Checkout OpenWrt Source
      uses: actions/checkout@v4
      with:
        submodules: true
        path: openwrt

    - name: Checkout Custom Files
      uses: actions/checkout@v4
      with:
        path: custom

    # 设置自定义 DTS 和配置
    - name: Setup Custom Configuration
      run: |
        echo "=== 复制自定义文件到 OpenWrt 源码 ==="
        
        # 复制 DTS 文件
        if [ -f "custom/dts/mt7981-emmc-rfb-z8102ax.dts" ]; then
          mkdir -p openwrt/target/linux/mediatek/dts/
          cp custom/dts/mt7981-emmc-rfb-z8102ax.dts openwrt/target/linux/mediatek/dts/
          echo "✓ DTS 文件已复制"
        else
          echo "⚠ 未找到自定义 DTS 文件，将无法编译 Z8102AX"
          exit 1
        fi

        # 复制配置文件
        if [ -f "custom/config/z8102ax-openwrt.config" ]; then
          cp custom/config/z8102ax-openwrt.config openwrt/
          echo "✓ 配置文件已复制"
        fi

        # 复制 patches
        if [ -d "custom/patches" ]; then
          cp -r custom/patches/* openwrt/patches/ 2>/dev/null || true
          echo "✓ Patches 已复制"
        fi

    # 设置构建环境
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-pip python3-setuptools \
          python3-dev rsync unzip zlib1g-dev file wget curl cmake libelf-dev \
          upx dos2unix libtool-bin time bc locales

        sudo locale-gen en_US.UTF-8

    - name: Clone OpenWrt Repository
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        if [ ! -d "openwrt/.git" ]; then
          rm -rf openwrt
          git clone --depth=1 --branch=${{ env.REPO_BRANCH }} ${{ env.REPO_URL }} openwrt
        else
          cd openwrt
          git fetch origin ${{ env.REPO_BRANCH }}
          git checkout ${{ env.REPO_BRANCH }}
          git pull origin ${{ env.REPO_BRANCH }}
        fi

    - name: Update and Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 添加自定义设备到 Makefile
    - name: Add Custom Device Definition (OpenWrt)
      run: |
        cd openwrt
        
        # 检查 mt7981.mk 是否存在
        if [ ! -f "target/linux/mediatek/image/mt7981.mk" ]; then
          echo "⚠ mt7981.mk 不存在，创建新文件"
          mkdir -p target/linux/mediatek/image/
          touch target/linux/mediatek/image/mt7981.mk
        fi
        
        # 备份原文件
        cp target/linux/mediatek/image/mt7981.mk target/linux/mediatek/image/mt7981.mk.bak
        
        # 添加 Z8102AX 设备定义
        cat >> target/linux/mediatek/image/mt7981.mk << 'EOF'

# ZBT Z8102AX (eMMC) 设备定义
define Device/zbtlink_z8102ax-emmc
  DEVICE_VENDOR := ZBT
  DEVICE_MODEL := Z8102AX (eMMC)
  DEVICE_DTS := mt7981-emmc-rfb-z8102ax
  DEVICE_DTS_DIR := \$$(DTS_DIR)/mediatek
  SUPPORTED_DEVICES := zbtlink,z8102ax-emmc mediatek,mt7981-emmc-rfb
  
  # eMMC 设备参数
  IMAGES := sysupgrade.bin
  IMAGE_SIZE := 116736k
  
  # OpenWrt 24.10.4 使用不同的内核打包方式
  KERNEL := kernel-bin | gzip | fit gzip \$$(KDIR)/image-\$$(firstword \$$(DEVICE_DTS)).dtb
  IMAGE/sysupgrade.bin := append-kernel | pad-to 64M | \\
        append-rootfs | pad-rootfs | check-size | append-metadata
  
  DEVICE_PACKAGES := kmod-mt7981-firmware kmod-mmc kmod-fs-ext4 kmod-fs-f2fs
endef
TARGET_DEVICES += zbtlink_z8102ax-emmc
EOF
        
        echo "✓ 已添加 Z8102AX 设备定义到 OpenWrt"

    # 配置编译选项
    - name: Configure Build (OpenWrt)
      run: |
        cd openwrt
        
        # 复制默认配置
        if [ -f "../custom/config/z8102ax-openwrt.config" ]; then
          cp ../custom/config/z8102ax-openwrt.config .config
          echo "✓ 使用自定义配置文件"
        else
          # 生成 OpenWrt 默认配置
          cat > .config << 'EOF'
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_mt7981=y
CONFIG_TARGET_mediatek_mt7981_DEVICE_zbtlink_z8102ax-emmc=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=2048
# LuCI
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-app-opkg=y
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
# 基础包
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_fdisk=y
CONFIG_PACKAGE_lsblk=y
CONFIG_PACKAGE_blkid=y
CONFIG_PACKAGE_e2fsprogs=y
CONFIG_PACKAGE_f2fs-tools=y
CONFIG_PACKAGE_resize2fs=y
# 网络工具
CONFIG_PACKAGE_iperf3=y
CONFIG_PACKAGE_ip-full=y
CONFIG_PACKAGE_tcpdump=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_wget=y
# 内核模块
CONFIG_PACKAGE_kmod-mmc=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-f2fs=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-usb-serial=y
CONFIG_PACKAGE_kmod-usb-serial-option=y
CONFIG_PACKAGE_kmod-usb-net=y
CONFIG_PACKAGE_kmod-usb-net-qmi-wwan=y
CONFIG_PACKAGE_kmod-usb-net-sierrawireless=y
CONFIG_PACKAGE_kmod-ipt-offload=y
# WiFi
CONFIG_PACKAGE_kmod-mt7981-firmware=y
CONFIG_PACKAGE_mt7981-wo-firmware=y
# 其他
CONFIG_PACKAGE_ppp-mod-pppoe=y
CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_odhcp6c=y
EOF
          echo "✓ 使用默认配置文件"
        fi
        
        # 运行 defconfig
        make defconfig
        echo "✓ 配置完成"

    # 开始编译
    - name: Build OpenWrt Firmware
      run: |
        cd openwrt
        make -j${{ env.BUILD_THREADS }} V=s 2>&1 | tee build.log
        
        # 检查编译结果
        FIRMWARE_PATH="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/openwrt-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ env.PROFILE }}-squashfs-sysupgrade.bin"
        if [ -f "$FIRMWARE_PATH" ]; then
          echo "✓ OpenWrt 编译成功！"
          ls -lh bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*.bin
          
          # 检查固件大小
          FIRMWARE_SIZE=$(stat -c%s "$FIRMWARE_PATH")
          FIRMWARE_SIZE_MB=$((FIRMWARE_SIZE / 1024 / 1024))
          echo "固件大小: ${FIRMWARE_SIZE_MB}MB"
          
          if [ $FIRMWARE_SIZE_MB -gt 100 ]; then
            echo "⚠ 固件大小超过 100MB，请检查配置"
          fi
        else
          echo "✗ OpenWrt 编译失败！"
          tail -100 build.log
          exit 1
        fi

    # 上传编译产物
    - name: Upload OpenWrt Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-z8102ax-firmware
        path: |
          openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*.bin
          openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/packages/
          openwrt/build.log
        retention-days: 30

    # 生成发布版本
    - name: Create OpenWrt Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        name: OpenWrt ${{ env.REPO_BRANCH }} for ZBT-Z8102AX
        tag_name: openwrt-${{ env.REPO_BRANCH }}-z8102ax-$(date +%Y%m%d)
        body: |
          # OpenWrt ${{ env.REPO_BRANCH }} for ZBT-Z8102AX (eMMC)
          
          ## 设备信息
          - **型号**: ZBT-Z8102AX (eMMC版本)
          - **平台**: MediaTek MT7981 (Filogic 820)
          - **存储**: 128GB eMMC
          - **内存**: 1GB DDR4
          - **网络**: 2.5G WAN + 4x Gigabit LAN
          
          ## 固件特性
          - 基于 OpenWrt ${{ env.REPO_BRANCH }}
          - 包含 LuCI Web 界面 (中文)
          - 支持 USB 4G 模块
          - 完整的网络功能
          - 64MB 内核分区优化
          
          ## 注意事项
          - OpenWrt 官方对 MT7981 支持可能不如 ImmortalWrt 完整
          - 如需更多功能建议使用 ImmortalWrt 版本
          
          ## 刷机说明
          1. 通过 Web 界面刷入 sysupgrade.bin
          2. 或通过 U-Boot 刷写
          
          ## 编译信息
          - **编译时间**: $(date)
          - **分支**: ${{ env.REPO_BRANCH }}
          - **提交**: ${{ github.sha }}
        files: |
          openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*.bin
        draft: false
        prerelease: false
