name: ImmortalWrt 24.10.4 for ZBT Z8102AX-eMMC

on:
  push:
    paths:
      - '**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: 检出ImmortalWrt源码
      uses: actions/checkout@v4
      with:
        repository: immortalwrt/immortalwrt
        ref: v24.10.4
        path: openwrt
    
    - name: 检出配置文件
      uses: actions/checkout@v4
      with:
        path: config-repo
    
    - name: 安装编译依赖
      run: |
        export DEBIAN_FRONTEND=noninteractive
        sudo apt-get update -qq
        sudo apt-get install -yq \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-dev \
          python3-setuptools \
          rsync \
          unzip \
          zlib1g-dev \
          gcc-multilib \
          flex \
          bison \
          gperf \
          patch \
          texinfo \
          wget \
          curl \
          lzop \
          upx-ucl \
          liblzma-dev \
          liblz4-tool \
          zstd \
          jq \
          subversion \
          swig \
          time \
          xsltproc
    
    - name: 准备设备支持
      working-directory: ./openwrt
      run: |
        # 复制DTS文件
        mkdir -p target/linux/mediatek/dts/
        cp ../config-repo/dts/mt7981-zbt-z8102ax-emmc.dts target/linux/mediatek/dts/
        
        # 添加设备定义到filogic.mk
        if ! grep -q "zbt_z8102ax-emmc" target/linux/mediatek/image/filogic.mk; then
          cat >> target/linux/mediatek/image/filogic.mk <<'DEVICEEOF'
        
        define Device/zbt_z8102ax-emmc
          DEVICE_VENDOR := ZBT
          DEVICE_MODEL := Z8102AX-eMMC
          DEVICE_DTS := mt7981-zbt-z8102ax-emmc
          SUPPORTED_DEVICES := zbt,z8102ax-emmc
          IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata
        endef
        TARGET_DEVICES += zbt_z8102ax-emmc
        DEVICEEOF
        fi
    
    - name: 更新Feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: 配置升级 - 修复版
      working-directory: ./openwrt
      run: |
        echo "=== 开始配置升级过程 ==="
        
        # 检查原厂配置文件
        if [ ! -f "../config-repo/config/original.config" ]; then
          echo "❌ 错误：未找到原厂配置文件"
          echo "请在config/目录中放置原厂21.02的.config文件，命名为original.config"
          exit 1
        fi
        
        # 方法1：使用defconfig创建基础配置
        echo "创建基础配置..."
        make defconfig
        
        # 方法2：安全地升级原厂配置
        echo "尝试安全升级原厂配置..."
        
        # 先备份当前配置
        cp .config .config.backup
        
        # 复制原厂配置
        cp ../config-repo/config/original.config .config.original
        
        # 使用更安全的方式升级配置
        echo "正在升级内核配置..."
        
        # 清理旧的编译文件
        make target/linux/clean
        
        # 使用非交互式方式接受所有默认值
        echo "执行非交互式配置升级..."
        cat <<'YESEOF' | make oldconfig
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        y
        YESEOF
        
        # 如果上述方法失败，使用备用方案
        if [ $? -ne 0 ]; then
          echo "⚠️ 交互式升级失败，使用备用方案..."
          
          # 重新开始，创建最小配置
          cp ../config-repo/config/original.config .config
          
          # 强制清理target/linux
          rm -rf tmp/
          make target/linux/clean
          
          # 使用脚本自动应答
          echo "使用脚本自动应答..."
          /bin/bash -c 'yes "" | make oldconfig 2>/dev/null | head -100' || true
        fi
        
        # 应用必要的修复配置
        echo "应用必要的配置修复..."
        cat >> .config <<'CONFIGEOF'
        # 分区大小
        CONFIG_TARGET_KERNEL_PARTSIZE=32
        CONFIG_TARGET_ROOTFS_PARTSIZE=7168
        
        # 内核压缩
        CONFIG_KERNEL_XZ=y
        # CONFIG_DEBUG_INFO is not set
        
        # EMMC支持
        CONFIG_MMC=y
        CONFIG_MMC_MTK=y
        CONFIG_MMC_SDHCI_MTK=y
        
        # MT7981驱动
        CONFIG_PACKAGE_kmod-mt7981-firmware=y
        CONFIG_PACKAGE_mt7981-wo-firmware=y
        
        # 目标平台
        CONFIG_TARGET_mediatek=y
        CONFIG_TARGET_mediatek_filogic=y
        CONFIG_TARGET_mediatek_filogic_DEVICE_zbt_z8102ax-emmc=y
        
        # 基础网络
        CONFIG_PACKAGE_kmod-ipt-core=y
        
        # LuCI基础
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-compat=y
        CONFIGEOF
        
        # 最终确认配置
        echo "最终配置检查..."
        make defconfig
        
        echo "✅ 配置升级完成"
    
    - name: 复制自定义文件
      working-directory: ./openwrt
      run: |
        if [ -d "../config-repo/files" ]; then
          cp -r ../config-repo/files/* files/
          echo "✅ 自定义文件已复制"
        fi
    
    - name: 下载源码
      working-directory: ./openwrt
      run: |
        echo "下载软件包源码..."
        make download -j$(nproc) V=s 2>&1 | tee download.log
        
        # 清理可能损坏的下载
        find dl -size -1024c -delete 2>/dev/null || true
    
    - name: 编译固件
      working-directory: ./openwrt
      timeout-minutes: 120
      run: |
        echo "开始编译..."
        
        # 先编译工具链
        echo "编译工具链..."
        make tools/compile -j$(nproc) V=s
        
        # 编译固件
        echo "编译固件..."
        make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log
        
        # 如果失败，尝试单线程
        if [ $? -ne 0 ]; then
          echo "并行编译失败，尝试单线程..."
          make -j1 V=s 2>&1 | tee build-single.log
        fi
    
    - name: 检查结果
      if: always()
      working-directory: ./openwrt
      run: |
        echo "=== 编译结果 ==="
        if [ -d "bin/targets/mediatek/filogic" ]; then
          echo "✅ 编译成功！固件文件："
          find bin/targets/mediatek/filogic -type f \( -name "*.bin" -o -name "*.tar" -o -name "*.img.gz" \) | xargs ls -lh
        else
          echo "❌ 编译失败"
          echo "最后100行日志："
          tail -100 build.log 2>/dev/null || echo "无日志文件"
        fi
    
    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-z8102ax
        path: |
          openwrt/bin/targets/mediatek/filogic/*
          openwrt/.config
          openwrt/build.log
        retention-days: 30
