name: OpenWrt 24.10.4 for ZBT Z8102AX-eMMC

on:
  push:
    paths:
      - '**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: 检出OpenWrt源码
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: v24.10.4
        path: openwrt
    
    - name: 检出配置文件
      uses: actions/checkout@v4
      with:
        path: config-repo
    
    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git libncurses5-dev libssl-dev python3 python3-distutils \
          python3-dev rsync zlib1g-dev flex bison
    
    - name: 准备设备支持
      working-directory: ./openwrt
      run: |
        # 复制DTS
        mkdir -p target/linux/mediatek/dts/
        cp ../config-repo/dts/mt7981-zbt-z8102ax-emmc.dts target/linux/mediatek/dts/
        
        # 添加到filogic.mk
        if ! grep -q "zbt_z8102ax-emmc" target/linux/mediatek/image/filogic.mk; then
          echo "" >> target/linux/mediatek/image/filogic.mk
          echo "define Device/zbt_z8102ax-emmc" >> target/linux/mediatek/image/filogic.mk
          echo "  DEVICE_VENDOR := ZBT" >> target/linux/mediatek/image/filogic.mk
          echo "  DEVICE_MODEL := Z8102AX-eMMC" >> target/linux/mediatek/image/filogic.mk
          echo "  DEVICE_DTS := mt7981-zbt-z8102ax-emmc" >> target/linux/mediatek/image/filogic.mk
          echo "  SUPPORTED_DEVICES := zbt,z8102ax-emmc" >> target/linux/mediatek/image/filogic.mk
          echo "  IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata" >> target/linux/mediatek/image/filogic.mk
          echo "endef" >> target/linux/mediatek/image/filogic.mk
          echo "" >> target/linux/mediatek/image/filogic.mk
          echo "TARGET_DEVICES += zbt_z8102ax-emmc" >> target/linux/mediatek/image/filogic.mk
        fi
    
    - name: 使用原厂配置
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        cp ../config-repo/config/original.config .config
        
        # 升级配置
        yes "" | make kernel_oldconfig 2>/dev/null || true
        
        # 必要配置
        cat >> .config << 'EOF'
CONFIG_TARGET_KERNEL_PARTSIZE=32
CONFIG_TARGET_ROOTFS_PARTSIZE=7168
CONFIG_KERNEL_XZ=y
CONFIG_MMC=y
CONFIG_MMC_MTK=y
CONFIG_PACKAGE_kmod-mt7981-firmware=y
CONFIG_TARGET_mediatek_filogic_DEVICE_zbt_z8102ax-emmc=y
EOF
        
        make defconfig
    
    - name: 编译
      working-directory: ./openwrt
      run: |
        make download -j$(nproc)
        make -j$(nproc) V=s 2>&1 | tee build.log
    
    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-z8102ax
        path: openwrt/bin/targets/mediatek/filogic/
        retention-days: 30
