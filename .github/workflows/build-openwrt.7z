name: OpenWrt 24.10.4 for ZBT Z8102AX-eMMC (使用原厂配置)

on:
  push:
    paths:
      - 'config/**'
      - '.github/workflows/build-openwrt.yml'
  workflow_dispatch:
    inputs:
      create_release:
        description: '创建GitHub Release'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: 检出OpenWrt源码
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: v24.10.4
        path: openwrt
    
    - name: 检出配置仓库
      uses: actions/checkout@v4
      with:
        path: config-repo
    
    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools \
          python3-dev rsync subversion swig time xsltproc zlib1g-dev \
          gcc-multilib flex bison gperf unzip patch texinfo wget curl
    
    - name: 添加设备支持
      working-directory: ./openwrt
      run: |
        # 复制DTS文件（如果有）
        if [ -f "../config-repo/dts/mt7981-zbt-z8102ax-emmc.dts" ]; then
          mkdir -p target/linux/mediatek/dts/
          cp ../config-repo/dts/mt7981-zbt-z8102ax-emmc.dts target/linux/mediatek/dts/
        fi
        
        # 添加设备定义到filogic.mk
        if ! grep -q "zbt_z8102ax-emmc" target/linux/mediatek/image/filogic.mk; then
          echo "" >> target/linux/mediatek/image/filogic.mk
          echo "define Device/zbt_z8102ax-emmc" >> target/linux/mediatek/image/filogic.mk
          echo "  DEVICE_VENDOR := ZBT" >> target/linux/mediatek/image/filogic.mk
          echo "  DEVICE_MODEL := Z8102AX-eMMC" >> target/linux/mediatek/image/filogic.mk
          if [ -f "../config-repo/dts/mt7981-zbt-z8102ax-emmc.dts" ]; then
            echo "  DEVICE_DTS := mt7981-zbt-z8102ax-emmc" >> target/linux/mediatek/image/filogic.mk
          else
            echo "  DEVICE_DTS := mt7981-zbtlink-z8102ax-emmc" >> target/linux/mediatek/image/filogic.mk
          fi
          echo "  DEVICE_DTS_DIR := \$(DTS_DIR)/mediatek" >> target/linux/mediatek/image/filogic.mk
          echo "  SUPPORTED_DEVICES := zbt,z8102ax-emmc" >> target/linux/mediatek/image/filogic.mk
          echo "  IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata" >> target/linux/mediatek/image/filogic.mk
          echo "endef" >> target/linux/mediatek/image/filogic.mk
          echo "" >> target/linux/mediatek/image/filogic.mk
          echo "TARGET_DEVICES += zbt_z8102ax-emmc" >> target/linux/mediatek/image/filogic.mk
        fi
    
    - name: 使用原厂配置升级
      working-directory: ./openwrt
      run: |
        echo "=== 开始配置升级 ==="
        
        # 更新feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 检查原厂配置是否存在
        if [ ! -f "../config-repo/config/original.config" ]; then
          echo "错误：未找到原厂配置文件 config/original.config"
          echo "请将原厂21.02的.config文件放入config/目录并命名为original.config"
          exit 1
        fi
        
        # 复制原厂配置
        cp ../config-repo/config/original.config .config
        
        echo "原厂配置已加载，开始升级到24.10.4..."
        
        # 备份原配置
        cp .config .config.original
        
        # 升级内核配置（从21.02升级到24.10.4）
        echo "升级内核配置..."
        yes "" | make kernel_oldconfig 2>/dev/null || {
          echo "内核配置升级遇到问题，继续..."
        }
        
        # 应用必要的配置修复和优化
        echo "应用必要配置修复..."
        cat >> .config << 'EOF'

# ========== 配置修复和优化 ==========
# 目标平台
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y

# 内核分区大小（保持原厂32MB）
CONFIG_TARGET_KERNEL_PARTSIZE=32
# RootFS分区大小（保持原厂7GB）
CONFIG_TARGET_ROOTFS_PARTSIZE=7168

# 内核压缩优化（使用XZ获得最佳压缩比）
CONFIG_KERNEL_XZ=y
# CONFIG_KERNEL_GZIP is not set
# CONFIG_KERNEL_BZIP2 is not set
# CONFIG_KERNEL_LZMA is not set
# CONFIG_KERNEL_LZO is not set

# 禁用调试信息以减小内核大小
# CONFIG_DEBUG_INFO is not set
# CONFIG_DEBUG_KERNEL is not set
CONFIG_CC_OPTIMIZE_FOR_SIZE=y

# EMMC/MMC支持（必需）
CONFIG_MMC=y
CONFIG_MMC_BLOCK=y
CONFIG_MMC_MTK=y
CONFIG_MMC_SDHCI_MTK=y
CONFIG_BLK_DEV_SD=y

# 文件系统支持
CONFIG_FS_EXT4=y
CONFIG_EXT4_FS_POSIX_ACL=y
CONFIG_EXT4_FS_SECURITY=y
CONFIG_FS_SQUASHFS=y
CONFIG_SQUASHFS_XZ=y

# 分区表支持
CONFIG_PARTITION_ADVANCED=y
CONFIG_EFI_PARTITION=y

# MT7981特定驱动
CONFIG_PACKAGE_kmod-mt7981-firmware=y
CONFIG_PACKAGE_mt7981-wo-firmware=y
CONFIG_PACKAGE_kmod-mt753x=y

# 基础网络
CONFIG_PACKAGE_kmod-ipt-core=y
CONFIG_PACKAGE_kmod-ipt-filter=y
CONFIG_PACKAGE_kmod-ipt-offload=y

# LuCI基础
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-app-opkg=y

# 确保设备被选中
CONFIG_TARGET_mediatek_filogic_DEVICE_zbt_z8102ax-emmc=y
EOF
        
        # 运行defconfig来规范化配置
        echo "规范化配置..."
        make defconfig
        
        # 显示关键配置
        echo "=== 关键配置检查 ==="
        grep -E "CONFIG_TARGET_KERNEL_PARTSIZE|CONFIG_TARGET_ROOTFS_PARTSIZE|CONFIG_KERNEL_XZ|CONFIG_MMC_MTK" .config || true
    
    - name: 下载源码
      working-directory: ./openwrt
      run: |
        echo "下载软件包源码..."
        make download -j$(nproc) V=s 2>&1 | tee download.log
        
        # 清理可能损坏的下载
        find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true
    
    - name: 编译
      working-directory: ./openwrt
      timeout-minutes: 150
      run: |
        echo "开始编译过程..."
        
        # 编译工具链
        echo "编译工具链..."
        make toolchain/compile -j$(nproc) V=s 2>&1 | tee toolchain.log
        
        # 编译固件
        echo "编译固件..."
        make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log
        
        # 如果失败，尝试单线程
        if [ $? -ne 0 ]; then
          echo "并行编译失败，尝试单线程..."
          make -j1 V=s 2>&1 | tee build-single.log
        fi
    
    - name: 验证编译结果
      if: success()
      working-directory: ./openwrt
      run: |
        echo "=== 验证编译结果 ==="
        
        # 查找生成的固件
        if [ -d "bin/targets/mediatek/filogic" ]; then
          echo "固件目录内容:"
          ls -la bin/targets/mediatek/filogic/
          
          echo ""
          echo "设备相关固件:"
          find bin/targets/mediatek/filogic -name "*zbt*" -o -name "*z8102ax*" | while read file; do
            if [ -f "$file" ]; then
              size=$(stat -c%s "$file" 2>/dev/null || echo "未知")
              human_size=$(numfmt --to=iec --suffix=B $size 2>/dev/null || echo "${size}字节")
              echo "- $(basename "$file") ($human_size)"
            fi
          done
        else
          echo "错误：未找到固件目录"
          exit 1
        fi
        
        # 检查配置差异
        echo ""
        echo "=== 配置差异摘要 ==="
        if [ -f ".config.original" ] && [ -f ".config" ]; then
          echo "原厂配置和新配置的主要差异:"
          diff -u .config.original .config | grep -E "^[-+]CONFIG_" | head -20 || echo "无显著差异"
        fi
    
    - name: 上传固件到Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-z8102ax-firmware
        path: |
          openwrt/bin/targets/mediatek/filogic/
          openwrt/.config
          openwrt/.config.original
          openwrt/build.log
        retention-days: 30
    
    - name: 创建GitHub Release
      if: github.event.inputs.create_release == 'true'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: openwrt/bin/targets/mediatek/filogic/*zbt_z8102ax-emmc*
        tag_name: openwrt-24.10.4-z8102ax-$(date +%Y%m%d-%H%M%S)
        name: OpenWrt 24.10.4 for ZBT Z8102AX-eMMC
        body: |
          OpenWrt 24.10.4 固件 for ZBT Z8102AX-eMMC
          
          基于原厂21.02配置升级编译
          
          编译时间: $(date)
          
          注意事项:
          1. 使用原厂21.02配置文件升级
          2. 内核分区: 32MB
          3. RootFS分区: 7GB
          4. 使用XZ内核压缩
          5. 包含EMMC驱动支持
        draft: true
        prerelease: false
