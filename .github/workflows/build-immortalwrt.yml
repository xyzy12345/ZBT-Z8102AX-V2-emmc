name: ImmortalWrt 24.10.4 for ZBT Z8102AX-eMMC

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: 检出ImmortalWrt源码
      uses: actions/checkout@v4
      with:
        repository: immortalwrt/immortalwrt
        ref: v24.10.4
        path: openwrt
    
    - name: 检出配置文件
      uses: actions/checkout@v4
      with:
        path: config-repo
    
    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-dev python3-setuptools \
          rsync unzip zlib1g-dev file wget curl
    
    - name: 准备设备DTS
      working-directory: ./openwrt
      run: |
        # 复制DTS文件
        mkdir -p target/linux/mediatek/dts/
        cp ../config-repo/dts/mt7981-zbt-z8102ax-emmc.dts target/linux/mediatek/dts/
        
        # 验证DTS文件
        echo "DTS文件内容:"
        head -20 target/linux/mediatek/dts/mt7981-zbt-z8102ax-emmc.dts
    
    - name: 添加设备定义
      working-directory: ./openwrt
      run: |
        # 备份原filogic.mk
        cp target/linux/mediatek/image/filogic.mk target/linux/mediatek/image/filogic.mk.backup
        
        # 在适当位置添加设备定义（在已有的设备定义后面）
        awk '
        /^TARGET_DEVICES \+=/ {
            # 在最后一个设备后面添加我们的设备
            print $0
            print "TARGET_DEVICES += zbt_z8102ax-emmc"
            next
        }
        /^define Device\/.*/ && !added {
            # 在设备定义区域添加新设备
            print ""
            print "define Device/zbt_z8102ax-emmc"
            print "  DEVICE_VENDOR := ZBT"
            print "  DEVICE_MODEL := Z8102AX-eMMC"
            print "  DEVICE_DTS := mt7981-zbt-z8102ax-emmc"
            print "  DEVICE_DTS_DIR := \$(DTS_DIR)/mediatek"
            print "  SUPPORTED_DEVICES := zbt,z8102ax-emmc"
            print "  DEVICE_PACKAGES := kmod-mt7981-firmware mt7981-wo-firmware"
            print "  IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata"
            print "endef"
            print ""
            added = 1
            next
        }
        { print }
        ' target/linux/mediatek/image/filogic.mk.backup > target/linux/mediatek/image/filogic.mk
        
        # 验证修改
        echo "检查设备定义:"
        grep -n "zbt_z8102ax-emmc" target/linux/mediatek/image/filogic.mk || echo "未找到设备定义"
    
    - name: 创建正确配置
      working-directory: ./openwrt
      run: |
        # 更新feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        echo "创建配置..."
        
        # 创建基础配置
        cat > .config << 'EOF'
# Target System
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y

# Device selection
CONFIG_TARGET_mediatek_filogic_DEVICE_zbt_z8102ax-emmc=y

# Kernel modules
CONFIG_PACKAGE_kmod-mt7981-firmware=y
CONFIG_PACKAGE_mt7981-wo-firmware=y
CONFIG_PACKAGE_kmod-mt753x=y

# Storage (EMMC)
CONFIG_PACKAGE_kmod-mmc=y
CONFIG_PACKAGE_kmod-mtk-mmc=y
CONFIG_PACKAGE_kmod-sdhci=y
CONFIG_PACKAGE_kmod-sdhci-mtk=y

# Filesystems
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-squashfs=y

# Base system
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-theme-bootstrap=y

# Network
CONFIG_PACKAGE_kmod-ipt-core=y
CONFIG_PACKAGE_iptables=y

# Utilities
CONFIG_PACKAGE_blkid=y
CONFIG_PACKAGE_blockdev=y
CONFIG_PACKAGE_fdisk=y
CONFIG_PACKAGE_lscpu=y

# Image configuration
CONFIG_TARGET_ROOTFS_PARTSIZE=7168
CONFIG_TARGET_KERNEL_PARTSIZE=32
CONFIG_KERNEL_XZ=y
EOF
        
        # 运行defconfig来规范化配置
        make defconfig
        
        # 验证设备选择
        echo "验证配置:"
        grep -E "CONFIG_TARGET.*zbt|CONFIG_TARGET.*DEVICE" .config || echo "未找到设备配置"
    
    - name: 创建升级脚本
      working-directory: ./openwrt
      run: |
        mkdir -p files/lib/upgrade/
        cat > files/lib/upgrade/platform.sh << 'EOF'
#!/bin/sh

RAMFS_COPY_BIN='blkid blockdev fw_printenv fw_setenv'
RAMFS_COPY_DATA="/etc/fw_env.config /var/lock/fw_printenv.lock"

platform_do_upgrade() {
    local board=$(board_name)
    
    echo "设备: $board"
    
    case "$board" in
    zbt,z8102ax-emmc)
        echo "使用MTK MMC升级..."
        mtk_mmc_do_upgrade "$1"
        ;;
    *)
        echo "使用默认升级..."
        default_do_upgrade "$1"
        ;;
    esac
}

PART_NAME=firmware

platform_check_image() {
    local board=$(board_name)
    local magic="$(get_magic_long "$1")"
    
    [ "$#" -gt 1 ] && return 1
    
    case "$board" in
    zbt,z8102ax-emmc)
        # 检查tar格式
        magic="$(dd if="$1" bs=1 skip=257 count=5 2>/dev/null)"
        [ "$magic" != "ustar" ] && {
            echo "Invalid image type."
            return 1
        }
        return 0
        ;;
    *)
        [ "$magic" != "d00dfeed" ] && {
            echo "Invalid image type."
            return 1
        }
        return 0
        ;;
    esac
}
EOF
        chmod +x files/lib/upgrade/platform.sh
    
    - name: 编译固件
      working-directory: ./openwrt
      timeout-minutes: 120
      run: |
        echo "开始下载源码..."
        make download -j$(nproc) V=s 2>&1 | tail -20
        
        echo "开始编译..."
        make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log
        
        # 检查编译结果
        if [ $? -eq 0 ]; then
          echo "编译完成"
        else
          echo "编译失败，查看错误..."
          tail -100 build.log
          exit 1
        fi
    
    - name: 检查生成的固件
      working-directory: ./openwrt
      run: |
        echo "=== 检查编译结果 ==="
        
        if [ -d "bin/targets/mediatek/filogic" ]; then
          echo "固件目录内容:"
          ls -la bin/targets/mediatek/filogic/
          
          echo ""
          echo "查找特定设备固件:"
          find bin/targets/mediatek/filogic -type f -name "*zbt*" -o -name "*z8102ax*" | while read file; do
            echo "找到: $file"
          done
          
          echo ""
          echo "所有固件文件:"
          find bin/targets/mediatek/filogic -type f \( -name "*.bin" -o -name "*.tar" -o -name "*.img.gz" \) | head -20
        else
          echo "错误：固件目录不存在"
          exit 1
        fi
        
        # 特别检查是否有sysupgrade.bin
        echo ""
        echo "检查sysupgrade文件:"
        find bin/targets/mediatek/filogic -name "*sysupgrade*" | head -10
    
    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-z8102ax
        path: |
          openwrt/bin/targets/mediatek/filogic/
          openwrt/.config
        retention-days: 30
