name: ImmortalWrt 24.10.4 for ZBT Z8102AX-eMMC (使用原厂配置)

on:
  push:
    paths:
      - 'config/**'
      - 'dts/**'
      - 'files/**'
      - '.github/workflows/build-immortalwrt.yml'
  workflow_dispatch:
    inputs:
      skip_download:
        description: '跳过下载步骤（使用缓存）'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: 检出ImmortalWrt源码
      uses: actions/checkout@v4
      with:
        repository: immortalwrt/immortalwrt
        ref: v24.10.4
        path: openwrt
    
    - name: 检出配置仓库
      uses: actions/checkout@v4
      with:
        path: config-repo
    
    - name: 安装编译依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
          file wget qemu-utils
    
    - name: 准备设备支持
      working-directory: ./openwrt
      run: |
        # 复制DTS文件
        mkdir -p target/linux/mediatek/dts/
        if [ -f "../config-repo/dts/mt7981-zbt-z8102ax-emmc.dts" ]; then
          cp ../config-repo/dts/mt7981-zbt-z8102ax-emmc.dts target/linux/mediatek/dts/
        else
          echo "警告：未找到DTS文件，将使用默认DTS"
        fi
        
        # 在filogic.mk中添加设备定义
        if ! grep -q "zbt_z8102ax-emmc" target/linux/mediatek/image/filogic.mk; then
          cat >> target/linux/mediatek/image/filogic.mk << 'EOF'

define Device/zbt_z8102ax-emmc
  DEVICE_VENDOR := ZBT
  DEVICE_MODEL := Z8102AX-eMMC
  DEVICE_DTS := mt7981-zbt-z8102ax-emmc
  DEVICE_DTS_DIR := $(DTS_DIR)/mediatek
  SUPPORTED_DEVICES := zbt,z8102ax-emmc
  IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata
endef
TARGET_DEVICES += zbt_z8102ax-emmc
EOF
        fi
    
    - name: 更新Feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: 使用原厂配置升级
      working-directory: ./openwrt
      run: |
        echo "=== 使用原厂配置 ==="
        if [ -f "../config-repo/config/original.config" ]; then
          # 复制原厂配置
          cp ../config-repo/config/original.config .config
          
          echo "原厂配置已应用，开始升级配置..."
          
          # 清理旧的配置差异
          make target/linux/clean
          
          # 升级内核配置（接受新选项的默认值）
          echo "正在升级内核配置..."
          yes "" | make kernel_oldconfig 2>/dev/null || true
          
          # 应用必要的配置修复
          echo "应用必要配置修复..."
          cat >> .config << 'EOF'

# ===== 必需修复的配置 =====
# 内核分区大小（32MB）
CONFIG_TARGET_KERNEL_PARTSIZE=32
# RootFS分区大小（7GB）
CONFIG_TARGET_ROOTFS_PARTSIZE=7168

# 内核压缩（使用XZ以获得更好的压缩比）
CONFIG_KERNEL_XZ=y
# CONFIG_KERNEL_GZIP is not set
# CONFIG_KERNEL_BZIP2 is not set
# CONFIG_KERNEL_LZMA is not set
# CONFIG_KERNEL_LZO is not set
# CONFIG_KERNEL_LZ4 is not set

# 禁用调试信息以减少内核大小
# CONFIG_DEBUG_INFO is not set
# CONFIG_DEBUG_INFO_COMPRESSED is not set
# CONFIG_DEBUG_INFO_REDUCED is not set

# EMMC/MMC支持
CONFIG_MMC=y
CONFIG_MMC_BLOCK=y
CONFIG_MMC_MTK=y
CONFIG_MMC_SDHCI_MTK=y
CONFIG_BLK_DEV_SD=y

# 文件系统支持
CONFIG_FS_EXT4=y
CONFIG_EXT4_FS_POSIX_ACL=y
CONFIG_EXT4_FS_SECURITY=y
CONFIG_FS_SQUASHFS=y
CONFIG_SQUASHFS_XZ=y

# MT7981特定驱动
CONFIG_PACKAGE_kmod-mt7981-firmware=y
CONFIG_PACKAGE_mt7981-wo-firmware=y
CONFIG_PACKAGE_kmod-mt753x=y

# LuCI基础
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-theme-bootstrap=y

# 目标平台
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y
CONFIG_TARGET_mediatek_filogic_DEVICE_zbt_z8102ax-emmc=y
EOF
          
          # 运行defconfig来规范化配置
          make defconfig
          
          echo "配置升级完成"
        else
          echo "错误：未找到原厂配置文件 config/original.config"
          exit 1
        fi
    
    - name: 复制自定义文件
      working-directory: ./openwrt
      run: |
        # 复制升级脚本
        mkdir -p files/lib/upgrade/
        if [ -f "../config-repo/files/lib/upgrade/platform.sh" ]; then
          cp ../config-repo/files/lib/upgrade/platform.sh files/lib/upgrade/
          chmod +x files/lib/upgrade/platform.sh
        else
          # 创建默认升级脚本
          cat > files/lib/upgrade/platform.sh << 'EOF'
#!/bin/sh

RAMFS_COPY_BIN='blkid blockdev fw_printenv fw_setenv'
RAMFS_COPY_DATA="/etc/fw_env.config /var/lock/fw_printenv.lock"

platform_do_upgrade() {
    local board=$(board_name)
    
    case "$board" in
    zbt,z8102ax-emmc)
        mtk_mmc_do_upgrade "$1"
        ;;
    *)
        default_do_upgrade "$1"
        ;;
    esac
}

PART_NAME=firmware

platform_check_image() {
    local board=$(board_name)
    local magic="$(get_magic_long "$1")"
    
    [ "$#" -gt 1 ] && return 1
    
    case "$board" in
    zbt,z8102ax-emmc)
        magic="$(dd if="$1" bs=1 skip=257 count=5 2>/dev/null)"
        [ "$magic" != "ustar" ] && {
            echo "Invalid image type."
            return 1
        }
        return 0
        ;;
    *)
        [ "$magic" != "d00dfeed" ] && {
            echo "Invalid image type."
            return 1
        }
        return 0
        ;;
    esac
}
EOF
          chmod +x files/lib/upgrade/platform.sh
        fi
    
    - name: 下载软件包
      if: github.event.inputs.skip_download != 'true'
      working-directory: ./openwrt
      run: |
        echo "开始下载软件包..."
        make download -j$(nproc) V=s 2>&1 | tee download.log
        
        # 清理可能损坏的下载文件
        find dl -size -1024c -delete 2>/dev/null || true
    
    - name: 编译固件
      working-directory: ./openwrt
      timeout-minutes: 120
      run: |
        echo "开始编译固件..."
        
        # 编译工具链
        echo "编译工具链..."
        make tools/compile -j$(nproc) V=s 2>&1 | tee tools.log
        
        # 编译固件
        echo "编译固件..."
        make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log
        
        # 如果失败，尝试单线程编译
        if [ $? -ne 0 ]; then
          echo "并行编译失败，尝试单线程..."
          make -j1 V=s 2>&1 | tee build-single.log
        fi
    
    - name: 检查编译结果
      if: always()
      working-directory: ./openwrt
      run: |
        echo "=== 编译结果 ==="
        
        # 检查生成的固件
        FIRMWARE_FILES=$(find bin/targets -name "*zbt_z8102ax-emmc*" -o -name "*.bin" -o -name "*.tar" 2>/dev/null | head -10)
        
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "找到固件文件:"
          for file in $FIRMWARE_FILES; do
            if [ -f "$file" ]; then
              size=$(stat -c%s "$file" 2>/dev/null || echo "未知")
              echo "- $(basename "$file") ($size 字节)"
            fi
          done
          
          # 检查内核大小
          KERNEL_FILE=$(find bin/targets -name "*kernel*" -o -name "*Image*" 2>/dev/null | head -1)
          if [ -f "$KERNEL_FILE" ]; then
            kernel_size=$(stat -c%s "$KERNEL_FILE" 2>/dev/null || echo 0)
            if [ $kernel_size -gt $((32*1024*1024)) ]; then
              echo "警告：内核文件超过32MB限制！"
            else
              echo "内核大小在限制内 ($kernel_size 字节)"
            fi
          fi
        else
          echo "未找到固件文件，编译可能失败"
          echo "最后100行日志："
          tail -100 build.log 2>/dev/null || tail -100 build-single.log 2>/dev/null || echo "无日志文件"
        fi
    
    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-z8102ax-firmware
        path: |
          openwrt/bin/targets/mediatek/filogic/
          openwrt/.config
          openwrt/build.log
        retention-days: 30
