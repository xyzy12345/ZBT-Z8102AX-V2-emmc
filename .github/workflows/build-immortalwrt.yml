name: ImmortalWrt 24.10.4 for ZBT Z8102AX-eMMC

on:
  push:
    paths:
      - 'config/**'
      - 'dts/**'
      - 'files/**'
      - '.github/workflows/build-immortalwrt.yml'
  workflow_dispatch:
    inputs:
      clean_build:
        description: '清理构建'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: 检出ImmortalWrt源码
      uses: actions/checkout@v4
      with:
        repository: immortalwrt/immortalwrt
        ref: v24.10.4
        path: openwrt
    
    - name: 检出配置文件
      uses: actions/checkout@v4
      with:
        path: config-repo
    
    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev
    
    - name: 准备设备树文件
      working-directory: ./openwrt
      run: |
        # 复制DTS文件
        mkdir -p target/linux/mediatek/dts/
        cp ../config-repo/dts/mt7981-zbt-z8102ax-emmc.dts target/linux/mediatek/dts/
        
        # 在filogic.mk中添加设备定义
        DEVICE_DEF="\define Device/zbt_z8102ax-emmc\n  DEVICE_VENDOR := ZBT\n  DEVICE_MODEL := Z8102AX-eMMC\n  DEVICE_DTS := mt7981-zbt-z8102ax-emmc\n  DEVICE_DTS_DIR := \$(DTS_DIR)/mediatek\n  SUPPORTED_DEVICES := zbt,z8102ax-emmc\n  UBINIZE_OPTS := -E 5\n  BLOCKSIZE := 128k\n  PAGESIZE := 2048\n  IMAGE_SIZE := 32768k\n  KERNEL_IN_UBI := 1\n  IMAGES := sysupgrade.tar\n  IMAGE/sysupgrade.tar := sysupgrade-tar | append-metadata\nendef\n\nTARGET_DEVICES += zbt_z8102ax-emmc"
        
        if ! grep -q "zbt_z8102ax-emmc" target/linux/mediatek/image/filogic.mk; then
          echo -e "$DEVICE_DEF" >> target/linux/mediatek/image/filogic.mk
        fi
    
    - name: 准备配置
      working-directory: ./openwrt
      run: |
        # 更新feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 复制配置文件
        cp ../config-repo/config/zbt-z8102ax-emmc.config .config
        
        # 应用配置升级
        yes "" | make kernel_oldconfig 2>/dev/null || true
        
        # 确保关键配置设置正确
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=32" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=7168" >> .config
        echo "CONFIG_KERNEL_XZ=y" >> .config
        echo "# CONFIG_DEBUG_INFO is not set" >> .config
        
        # 最终确认配置
        make defconfig
    
    - name: 复制自定义文件
      working-directory: ./openwrt
      run: |
        if [ -d "../config-repo/files" ]; then
          cp -r ../config-repo/files/* files/
        fi
    
    - name: 下载源码
      working-directory: ./openwrt
      run: |
        make download -j$(nproc) V=s
    
    - name: 编译固件
      working-directory: ./openwrt
      run: |
        make -j$(nproc) V=s 2>&1 | tee build.log
    
    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-z8102ax-firmware
        path: |
          openwrt/bin/targets/mediatek/filogic/*zbt_z8102ax-emmc*
          openwrt/.config
        retention-days: 30
