---
name: ImmortalWrt 24.10.4 for ZBT Z8102AX-eMMC

"on":
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: 检出ImmortalWrt源码
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: v24.10.4
          path: openwrt

      - name: 检出配置文件
        uses: actions/checkout@v4
        with:
          path: config-repo

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib gettext git libncurses5-dev libssl-dev python3 \
            python3-dev python3-setuptools rsync unzip zlib1g-dev file wget curl

      - name: 准备设备DTS
        working-directory: ./openwrt
        run: |
          # 复制DTS文件（使用OpenWrt 24.10兼容的版本）
          mkdir -p target/linux/mediatek/dts/
          cp ../config-repo/dts/mt7981b-zbtlink-zbt-z8102ax-v2-emmc.dts \
            target/linux/mediatek/dts/

          # 验证DTS文件
          echo "DTS文件已复制："
          # yamllint disable-line rule:line-length
          ls -l target/linux/mediatek/dts/mt7981b-zbtlink-zbt-z8102ax-v2-emmc.dts
          echo ""
          echo "DTS文件头部内容:"
          # yamllint disable-line rule:line-length
          head -30 target/linux/mediatek/dts/mt7981b-zbtlink-zbt-z8102ax-v2-emmc.dts

      - name: 添加设备定义到filogic.mk
        working-directory: ./openwrt
        run: |
          # 检查设备是否已定义
          if ! grep -q "zbtlink_z8102ax-emmc" \
              target/linux/mediatek/image/filogic.mk; then
            echo "在filogic.mk中添加eMMC版本设备定义..."

            # 在文件末尾添加eMMC版本的设备定义
          cat >> target/linux/mediatek/image/filogic.mk << 'EOF'

          define Device/zbtlink_z8102ax-emmc
            DEVICE_VENDOR := ZBT
            DEVICE_MODEL := Z8102AX eMMC
            DEVICE_DTS := mt7981b-zbtlink-zbt-z8102ax-v2-emmc
            DEVICE_DTS_DIR := $(DTS_DIR)/mediatek
            SUPPORTED_DEVICES := zbtlink,z8102ax-emmc
            # eMMC specific settings (not NAND/UBI)
            KERNEL_SIZE := 32768k
            ROOTFS_SIZE := 7340032k
            BLOCKSIZE := 64k
            PAGESIZE := 2048
            IMAGES := sysupgrade.bin
            IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata
            DEVICE_PACKAGES := kmod-mt7981-firmware mt7981-wo-firmware \
              kmod-usb3 kmod-mmc kmod-mmc-mtk kmod-mt753x swconfig
          endef
          TARGET_DEVICES += zbtlink_z8102ax-emmc
          EOF
            echo "设备定义已添加"
          else
            echo "设备定义已存在"
          fi

          # 验证修改
          echo "检查设备定义:"
          grep -A 10 "define Device/zbtlink_z8102ax-emmc" \
            target/linux/mediatek/image/filogic.mk || echo "未找到设备定义"

      - name: 使用预配置文件
        working-directory: ./openwrt
        run: |
          # 更新feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          echo "使用configs/immortalwrt.config配置..."

          # 复制预配置文件（适配ImmortalWrt 24.10）
          cp ../config-repo/configs/immortalwrt.config .config

          # 运行defconfig来规范化配置
          make defconfig

          # 验证设备选择
          echo "验证配置:"
          grep -E "CONFIG_TARGET.*zbtlink|CONFIG_TARGET.*DEVICE" \
            .config | head -15
          grep -E "CONFIG_TARGET_BOARD|CONFIG_TARGET_SUBTARGET" \
            .config | head -5

      - name: 创建升级脚本
        working-directory: ./openwrt
        run: |
          mkdir -p files/lib/upgrade/
          cat > files/lib/upgrade/platform.sh << 'EOF'
          #!/bin/sh

          RAMFS_COPY_BIN='blkid blockdev fw_printenv fw_setenv'
          RAMFS_COPY_DATA="/etc/fw_env.config /var/lock/fw_printenv.lock"

          platform_do_upgrade() {
              local board=$(board_name)

              echo "设备: $board"

              case "$board" in
              zbt,z8102ax-emmc)
                  echo "使用MTK MMC升级..."
                  mtk_mmc_do_upgrade "$1"
                  ;;
              *)
                  echo "使用默认升级..."
                  default_do_upgrade "$1"
                  ;;
              esac
          }

          PART_NAME=firmware

          platform_check_image() {
              local board=$(board_name)
              local magic="$(get_magic_long "$1")"

              [ "$#" -gt 1 ] && return 1

              case "$board" in
              zbt,z8102ax-emmc)
                  # 检查tar格式
                  magic="$(dd if="$1" bs=1 skip=257 count=5 2>/dev/null)"
                  [ "$magic" != "ustar" ] && {
                      echo "Invalid image type."
                      return 1
                  }
                  return 0
                  ;;
              *)
                  [ "$magic" != "d00dfeed" ] && {
                      echo "Invalid image type."
                      return 1
                  }
                  return 0
                  ;;
              esac
          }
          EOF
          chmod +x files/lib/upgrade/platform.sh

      - name: 编译固件
        working-directory: ./openwrt
        timeout-minutes: 120
        run: |
          echo "开始下载源码..."
          make download -j$(nproc) V=s 2>&1 | tail -20

          echo "开始编译..."
          make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log

          # 检查编译结果
          if [ $? -eq 0 ]; then
            echo "编译完成"
          else
            echo "编译失败，查看错误..."
            tail -100 build.log
            exit 1
          fi

      - name: 检查生成的固件
        working-directory: ./openwrt
        run: |
          echo "=== 检查编译结果 ==="

          if [ -d "bin/targets/mediatek/filogic" ]; then
            echo "固件目录内容:"
            ls -la bin/targets/mediatek/filogic/

            echo ""
            echo "查找特定设备固件:"
            find bin/targets/mediatek/filogic -type f -name "*zbt*" \
              -o -name "*z8102ax*" | while read file; do
              echo "找到: $file"
            done

            echo ""
            echo "所有固件文件:"
            # yamllint disable-line rule:line-length
            find bin/targets/mediatek/filogic -type f \
              \( -name "*.bin" -o -name "*.tar" -o -name "*.img.gz" \) \
              | head -20
          else
            echo "错误：固件目录不存在"
            exit 1
          fi

          # 特别检查是否有sysupgrade.bin
          echo ""
          echo "检查sysupgrade文件:"
          find bin/targets/mediatek/filogic -name "*sysupgrade*" | head -10

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-z8102ax
          path: |
            openwrt/bin/targets/mediatek/filogic/
            openwrt/.config
          retention-days: 30
